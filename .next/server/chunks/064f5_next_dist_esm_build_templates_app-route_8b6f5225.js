module.exports=[64897,e=>{"use strict";var t=e.i(5246),a=e.i(9381),r=e.i(53516),n=e.i(88513),s=e.i(6151),o=e.i(50059),i=e.i(66602),c=e.i(52444),l=e.i(14694),d=e.i(49691),u=e.i(7726),p=e.i(34583),_=e.i(41813),m=e.i(36356),h=e.i(65931),f=e.i(93695);e.i(94173);var g=e.i(51092),w=e.i(44064),v=e.i(69343);let E=process.env.NEXT_PUBLIC_SUPABASE_URL||"https://placeholder.supabase.co",R=process.env.SUPABASE_SERVICE_ROLE_KEY||"placeholder-key",y=((0,v.createClient)(E,R),(0,v.createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY));async function q(e){let t,a;if(t=e.headers.get("authorization"),(a=process.env.CRON_SECRET)?t!==`Bearer ${a}`:(console.warn("[v0] CRON_SECRET not set"),!0))return w.NextResponse.json({error:"Unauthorized"},{status:401});let r=Date.now(),n={scheduledTasks:{processed:0,errors:0},sequences:{processed:0,errors:0},withering:{processed:0,errors:0},breakups:{processed:0,errors:0}};try{await S(n),await A(n),await T(n),await O(n);let e=Date.now()-r;return console.log("[v0] Cron job completed",{results:n,durationMs:e}),w.NextResponse.json({success:!0,message:"Automations processed",results:n,durationMs:e})}catch(e){return console.error("[v0] Cron job error:",e),w.NextResponse.json({error:"Internal server error",details:String(e)},{status:500})}}async function S(e){try{let{data:t,error:a}=await y.from("scheduled_tasks").select(`
        *,
        contact:contacts(id, email, first_name, last_name, tenant_id)
      `).eq("status","pending").lte("scheduled_for",new Date().toISOString()).limit(100);if(a){console.error("[v0] Error fetching scheduled tasks:",a),e.scheduledTasks.errors++;return}for(let a of t||[])try{if(a.attempts>=a.max_attempts){await y.from("scheduled_tasks").update({status:"failed",error_message:"Max attempts exceeded"}).eq("id",a.id),e.scheduledTasks.errors++;continue}await y.from("scheduled_tasks").update({status:"processing",attempts:a.attempts+1,last_attempt_at:new Date().toISOString()}).eq("id",a.id);let t=!1;switch(a.task_type){case"send_email":t=await k(a);break;case"follow_up":t=await C(a);break;case"check_engagement":t=await b(a);break;case"update_status":t=await x(a);break;default:console.log("[v0] Unknown task type:",a.task_type),t=!0}await y.from("scheduled_tasks").update({status:t?"completed":"pending",completed_at:t?new Date().toISOString():null,result:{success:t}}).eq("id",a.id),t?e.scheduledTasks.processed++:e.scheduledTasks.errors++}catch(t){console.error("[v0] Error processing task:",t),await y.from("scheduled_tasks").update({status:"pending",error_message:String(t)}).eq("id",a.id),e.scheduledTasks.errors++}}catch(t){console.error("[v0] Error in processScheduledTasks:",t),e.scheduledTasks.errors++}}async function k(e){let{to:t,subject:a,body:r}=e.payload||{},n=t||e.contact?.email;return n?(console.log("[v0] Would send email:",{to:n,subject:a}),!0):(console.error("[v0] No recipient email for send_email task"),!1)}async function C(e){if(!e.contact)return!1;let{data:t}=await y.from("tenant_users").select("user_id").eq("tenant_id",e.contact.tenant_id);if(t)for(let a of t)await y.from("notifications").insert({tenant_id:e.contact.tenant_id,user_id:a.user_id,title:"Follow-up Reminder",message:`Time to follow up with ${e.contact.first_name}`,type:"action_required",contact_id:e.contact.id});return!0}async function b(e){return!!e.contact&&(console.log("[v0] Checking engagement for contact:",e.contact.id),!0)}async function x(e){return!!e.contact&&!!e.payload?.new_status&&(await y.from("contacts").update({status:e.payload.new_status}).eq("id",e.contact.id),!0)}async function A(e){try{let{data:t,error:a}=await y.from("contact_sequences").select(`
        *,
        contact:contacts(id, email, first_name, last_name, tenant_id),
        sequence:sequences(id, name, steps)
      `).eq("status","active").lte("next_step_at",new Date().toISOString()).limit(100);if(a){console.error("[v0] Error fetching sequence contacts:",a),e.sequences.errors++;return}for(let a of t||[])try{let t=a.sequence,r=a.current_step||0,n=t?.steps||[];if(r>=n.length){await y.from("contact_sequences").update({status:"completed",completed_at:new Date().toISOString()}).eq("id",a.id),await y.rpc("increment_sequence_completed",{sequence_id:t?.id});continue}let s=n[r];console.log("[v0] Would send sequence email:",{contact:a.contact?.email,sequence:t?.name,step:r+1,subject:s?.subject});let o=n[r+1]?.delay_days||0,i=new Date;i.setDate(i.getDate()+o),await y.from("contact_sequences").update({current_step:r+1,next_step_at:r+1<n.length?i.toISOString():null,emails_sent:a.emails_sent+1}).eq("id",a.id),e.sequences.processed++}catch(t){console.error("[v0] Error processing sequence step:",t),e.sequences.errors++}}catch(t){console.error("[v0] Error in processEmailSequences:",t),e.sequences.errors++}}async function T(e){try{let t=new Date;t.setDate(t.getDate()-14);let{data:a,error:r}=await y.from("contacts").select("id, email, first_name, last_name, tenant_id, last_contact_date").lt("last_contact_date",t.toISOString()).neq("status","Withering").neq("status","Dead").limit(100);if(r){console.error("[v0] Error fetching withering contacts:",r),e.withering.errors++;return}for(let t of a||[])try{if(await y.from("contacts").update({status:"Withering"}).eq("id",t.id),t.tenant_id){let{data:e}=await y.from("tenant_users").select("user_id").eq("tenant_id",t.tenant_id);if(e){let a=e.map(e=>({tenant_id:t.tenant_id,user_id:e.user_id,title:"Contact Needs Attention",message:`${t.first_name} ${t.last_name} has had no activity in 14+ days`,type:"warning",contact_id:t.id}));await y.from("notifications").insert(a)}}await y.from("conversation_events").insert({contact_id:t.id,tenant_id:t.tenant_id,event_type:"status_changed",event_data:{old_status:"active",new_status:"Withering",reason:"No activity in 14+ days"}}),e.withering.processed++}catch(t){console.error("[v0] Error processing withering contact:",t),e.withering.errors++}}catch(t){console.error("[v0] Error in checkWitheringContacts:",t),e.withering.errors++}}async function O(e){try{let{data:t,error:a}=await y.from("contact_sequences").select(`
        *,
        contact:contacts(id, email, first_name, last_name, tenant_id),
        sequence:sequences(id, name, steps)
      `).eq("status","active").lte("next_step_at",new Date().toISOString()).limit(50);if(a){console.error("[v0] Error fetching breakup contacts:",a),e.breakups.errors++;return}for(let a of(t||[]).filter(e=>{let t=e.sequence;return t?.name?.toLowerCase().includes("break")||t?.name?.toLowerCase().includes("goodbye")}))try{let t=a.sequence,r=a.current_step||0,n=t?.steps||[],s=n.length||3;if(r>=s){let e=a.contact;e&&(await y.from("contacts").update({status:"Dead"}).eq("id",e.id),await y.from("conversation_events").insert({contact_id:e.id,tenant_id:e.tenant_id,event_type:"status_changed",event_data:{old_status:"Withering",new_status:"Dead",reason:"Completed break-up sequence with no response"}})),await y.from("contact_sequences").update({status:"completed",completed_at:new Date().toISOString()}).eq("id",a.id);continue}console.log("[v0] Would send break-up email:",{contact:a.contact?.email,step:r+1});let o=n[r]?.delay_days||3,i=new Date;i.setDate(i.getDate()+o),await y.from("contact_sequences").update({current_step:r+1,next_step_at:i.toISOString(),emails_sent:a.emails_sent+1}).eq("id",a.id),e.breakups.processed++}catch(t){console.error("[v0] Error processing breakup:",t),e.breakups.errors++}}catch(t){console.error("[v0] Error in processBreakupSequences:",t),e.breakups.errors++}}e.s(["GET",()=>q,"dynamic",0,"force-dynamic"],73364);var D=e.i(73364);let N=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/automations/route",pathname:"/api/cron/automations",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/cron/automations/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:I,workUnitAsyncStorage:P,serverHooks:U}=N;function H(){return(0,r.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:P})}async function M(e,t,r){N.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/cron/automations/route";w=w.replace(/\/index$/,"")||"/";let v=await N.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:E,params:R,nextConfig:y,parsedUrl:q,isDraftMode:S,prerenderManifest:k,routerServerContext:C,isOnDemandRevalidate:b,revalidateOnlyGenerated:x,resolvedPathname:A,clientReferenceManifest:T,serverActionsManifest:O}=v,D=(0,i.normalizeAppPath)(w),I=!!(k.dynamicRoutes[D]||k.routes[A]),P=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,q,!1):t.end("This page could not be found"),null);if(I&&!S){let e=!!k.routes[A],t=k.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await P();throw new f.NoFallbackError}}let U=null;!I||N.isDev||S||(U="/index"===(U=A)?"/":U);let H=!0===N.isDev||!I,M=I&&!H;O&&T&&(0,o.setManifestsSingleton)({page:w,clientReferenceManifest:T,serverActionsManifest:O});let j=e.method||"GET",B=(0,s.getTracer)(),L=B.getActiveScopeSpan(),$={params:R,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,n)=>N.onRequestError(e,t,r,n,C)},sharedContext:{buildId:E}},K=new c.NodeNextRequest(e),W=new c.NodeNextResponse(t),F=l.NextRequestAdapter.fromNodeNextRequest(K,(0,l.signalFromNodeResponse)(t));try{let o=async e=>N.handle(F,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=B.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${j} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${w}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var s,c;let l=async({previousCacheEntry:a})=>{try{if(!i&&b&&x&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(n);e.fetchMetrics=$.renderOpts.fetchMetrics;let c=$.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let l=$.renderOpts.collectedTags;if(!I)return await (0,p.sendResponse)(K,W,s,$.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(s.headers);l&&(t[h.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,r=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:b})},!1,C),t}},d=await N.handleResponse({req:e,nextConfig:y,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:x,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:i});if(!I)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",b?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,_.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&I||f.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(K,W,new Response(d.value.body,{headers:f,status:d.value.status||200})),null};L?await c(L):await B.withPropagatedContext(e.headers,()=>B.trace(d.BaseServerSpan.handleRequest,{spanName:`${j} ${w}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},c))}catch(t){if(t instanceof f.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:b})},!1,C),I)throw t;return await (0,p.sendResponse)(K,W,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>H,"routeModule",()=>N,"serverHooks",()=>U,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>P],64897)}];

//# sourceMappingURL=064f5_next_dist_esm_build_templates_app-route_8b6f5225.js.map