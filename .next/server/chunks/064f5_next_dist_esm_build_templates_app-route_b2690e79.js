module.exports=[64335,e=>{"use strict";var t=e.i(5246),a=e.i(9381),n=e.i(53516),r=e.i(88513),i=e.i(6151),s=e.i(50059),o=e.i(66602),l=e.i(52444),d=e.i(14694),c=e.i(49691),u=e.i(7726),p=e.i(34583),m=e.i(41813),g=e.i(36356),f=e.i(65931),_=e.i(93695);e.i(94173);var h=e.i(51092),v=e.i(44064),w=e.i(69343),R=e.i(54799);let b=(0,w.createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY);function E(e,t){if(!e||!t)return 0;let a=Math.max(e.length,t.length);return 0===a?1:1-function(e,t){let a=e.toLowerCase(),n=t.toLowerCase(),r=a.length,i=n.length,s=Array(r+1).fill(null).map(()=>Array(i+1).fill(0));for(let e=0;e<=r;e++)s[e][0]=e;for(let e=0;e<=i;e++)s[0][e]=e;for(let e=1;e<=r;e++)for(let t=1;t<=i;t++)a[e-1]===n[t-1]?s[e][t]=s[e-1][t-1]:s[e][t]=1+Math.min(s[e-1][t],s[e][t-1],s[e-1][t-1]);return s[r][i]}(e,t)/a}async function y(e,t){let a=e.split(/\s+/).filter(Boolean),n=a[0]||"",r=a.slice(1).join(" ")||"",i=t?.split("@")[1]?.toLowerCase(),{data:s}=await b.from("contacts").select("id, tenant_id, first_name, last_name, company, email").or(`first_name.ilike.%${n.substring(0,3)}%,last_name.ilike.%${r.substring(0,3)}%`).limit(50);if(!s||0===s.length)return null;let o=s.map(t=>{let a=E(e,`${t.first_name||""} ${t.last_name||""}`.trim()),s=E(n,t.first_name||""),o=E(r,t.last_name||""),l=t.email?.split("@")[1]?.toLowerCase();return{contact:t,score:Math.max(a,.4*s+.6*o)+(l&&i&&l===i?.2:0)}});o.sort((e,t)=>t.score-e.score);let l=o[0];return l&&l.score>=.7?(console.log(`[v0] Fuzzy name match: "${e}" matched to "${l.contact.first_name} ${l.contact.last_name}" (score: ${l.score.toFixed(2)})`),{id:l.contact.id,tenant_id:l.contact.tenant_id}):(console.log(`[v0] No fuzzy match found for "${e}" (best score: ${l?.score.toFixed(2)||0})`),null)}async function x(e){let t=e.headers.get("content-type")||"";if(t.includes("application/x-www-form-urlencoded"))return Object.fromEntries(new URLSearchParams(await e.text()).entries());if(t.includes("multipart/form-data")){let t=await e.formData(),a={};return t.forEach((e,t)=>{"string"==typeof e&&(a[t]=e)}),a}try{return await e.json()}catch{return{}}}async function S(e,t){let a=t["message-id"]||t["Message-Id"]||t.messageId,n=t.recipient||t.to;if(!a)return console.warn("[v0] No message ID in tracking event"),null;let r={delivered:"delivered",opened:"opened",clicked:"clicked",bounced:"bounced",dropped:"failed",complained:"complained",unsubscribed:"unsubscribed"}[e];if(!r)return null;let{data:i,error:s}=await b.from("email_messages").update({status:r,updated_at:new Date().toISOString(),mailgun_variables:b.rpc?void 0:{last_event:e,last_event_at:new Date().toISOString(),...t.url&&{clicked_url:t.url}}}).eq("message_id",a).select("id, contact_id, tenant_id").single();if(s){let{data:e}=await b.from("email_messages").update({status:r,updated_at:new Date().toISOString()}).eq("to_email",n).eq("direction","outbound").order("created_at",{ascending:!1}).limit(1).select("id, contact_id, tenant_id").single();return e||(console.error("[v0] Error updating email status:",s),null)}return i?.contact_id&&["opened","clicked","bounced"].includes(e)&&(await b.from("conversation_events").insert({contact_id:i.contact_id,tenant_id:i.tenant_id,event_type:`email_${e}`,event_data:{email_id:i.id,...t.url&&{url:t.url}}}),["opened","clicked"].includes(e)&&await b.from("contacts").update({last_contact_date:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",i.contact_id)),i}async function I(e){let t={messageId:e["Message-Id"]||e["message-id"]||e.messageId,from:e.from||e.sender,to:e.recipient||e.To||e.to,subject:e.subject||e.Subject,bodyPlain:e["body-plain"]||e.bodyPlain||e["stripped-text"],bodyHtml:e["body-html"]||e.bodyHtml||e["stripped-html"],strippedText:e["stripped-text"],strippedHtml:e["stripped-html"],timestamp:e.timestamp?new Date(1e3*parseInt(e.timestamp)).toISOString():new Date().toISOString(),attachments:e.attachments?JSON.parse(e.attachments):[],headers:e["message-headers"]?JSON.parse(e["message-headers"]):{},inReplyTo:e["In-Reply-To"]||e["in-reply-to"],references:e.References||e.references};console.log("[v0] Received incoming email:",{from:t.from,to:t.to,subject:t.subject});let a=t.from?.match(/^(?:"?([^"<]+)"?\s*)?<?([^>]+)>?$/),n=a?.[1]?.trim()||"",r=a?.[2]?.trim()||t.from,{data:i}=await b.from("contacts").select("id, tenant_id").eq("email",r?.toLowerCase()).single();!i&&n&&(i=await y(n,r));let{data:s,error:o}=await b.from("email_messages").insert({message_id:t.messageId,contact_id:i?.id||null,tenant_id:i?.tenant_id||null,direction:"inbound",from_email:t.from,to_email:t.to,subject:t.subject,body_plain:t.bodyPlain,body_html:t.bodyHtml,stripped_text:t.strippedText,received_at:t.timestamp,in_reply_to:t.inReplyTo,references_header:t.references,attachments:t.attachments,mailgun_variables:{headers:t.headers},status:"received"}).select().single();if(o&&console.error("[v0] Error storing email:",o),i){await b.from("contacts").update({last_contact_date:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",i.id),await b.from("conversation_events").insert({contact_id:i.id,tenant_id:i.tenant_id,event_type:"email_received",event_data:{email_id:s?.id,from:t.from,subject:t.subject,preview:t.strippedText?.substring(0,200)}});let{data:e}=await b.from("tenant_users").select("user_id").eq("tenant_id",i.tenant_id);if(e&&e.length>0){let a=e.map(e=>({tenant_id:i.tenant_id,user_id:e.user_id,title:"New Email Received",message:`${r} sent: ${t.subject||"(no subject)"}`,type:"info",contact_id:i.id}));await b.from("notifications").insert(a)}}return{storedEmail:s,contact:i}}async function C(e){try{let t=await x(e),a=t.timestamp||t["signature[timestamp]"],n=t.token||t["signature[token]"],r=t.signature||t["signature[signature]"];if(a&&n&&r){let e;if((e=process.env.MAILGUN_WEBHOOK_SIGNING_KEY)?R.default.createHmac("sha256",e).update(a.concat(n)).digest("hex")!==r:(console.warn("[v0] MAILGUN_WEBHOOK_SIGNING_KEY not set, skipping signature verification"),!1))return console.error("[v0] Invalid Mailgun webhook signature"),v.NextResponse.json({error:"Invalid signature"},{status:401})}let i=t.event||t["event-data"]?.event||"stored";if(console.log("[v0] Mailgun webhook event:",i),"stored"===i||t["body-plain"]||t.from){let{storedEmail:e,contact:a}=await I(t);return v.NextResponse.json({success:!0,message:"Email processed",emailId:e?.id,contactId:a?.id})}if(!["delivered","opened","clicked","bounced","dropped","complained","unsubscribed"].includes(i))return console.log("[v0] Unknown Mailgun event type:",i,t),v.NextResponse.json({success:!0,message:"Event acknowledged"});{let e=await S(i,t);return v.NextResponse.json({success:!0,message:`Event ${i} processed`,emailId:e?.id})}}catch(e){return console.error("[v0] Error processing Mailgun webhook:",e),v.NextResponse.json({error:"Internal server error"},{status:500})}}async function N(){return v.NextResponse.json({status:"ok",message:"Mailgun webhook endpoint active"})}e.s(["GET",()=>N,"POST",()=>C],69802);var O=e.i(69802);let A=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/webhooks/mailgun/route",pathname:"/api/webhooks/mailgun",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/webhooks/mailgun/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:k,workUnitAsyncStorage:T,serverHooks:P}=A;function j(){return(0,n.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:T})}async function D(e,t,n){A.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/webhooks/mailgun/route";v=v.replace(/\/index$/,"")||"/";let w=await A.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:R,params:b,nextConfig:E,parsedUrl:y,isDraftMode:x,prerenderManifest:S,routerServerContext:I,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,resolvedPathname:O,clientReferenceManifest:k,serverActionsManifest:T}=w,P=(0,o.normalizeAppPath)(v),j=!!(S.dynamicRoutes[P]||S.routes[O]),D=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,y,!1):t.end("This page could not be found"),null);if(j&&!x){let e=!!S.routes[O],t=S.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await D();throw new _.NoFallbackError}}let H=null;!j||A.isDev||x||(H="/index"===(H=O)?"/":H);let M=!0===A.isDev||!j,U=j&&!M;T&&k&&(0,s.setManifestsSingleton)({page:v,clientReferenceManifest:k,serverActionsManifest:T});let $=e.method||"GET",q=(0,i.getTracer)(),L=q.getActiveScopeSpan(),K={params:b,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,r)=>A.onRequestError(e,t,n,r,I)},sharedContext:{buildId:R}},B=new l.NodeNextRequest(e),F=new l.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let s=async e=>A.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${v}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var i,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&C&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(r);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!j)return await (0,p.sendResponse)(B,F,i,K.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})},!1,I),t}},c=await A.handleResponse({req:e,nextConfig:E,cacheKey:H,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:o});if(!j)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&j||_.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(B,F,new Response(c.value.body,{headers:_,status:c.value.status||200})),null};L?await l(L):await q.withPropagatedContext(e.headers,()=>q.trace(c.BaseServerSpan.handleRequest,{spanName:`${$} ${v}`,kind:i.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})},!1,I),j)throw t;return await (0,p.sendResponse)(B,F,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>j,"routeModule",()=>A,"serverHooks",()=>P,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>T],64335)}];

//# sourceMappingURL=064f5_next_dist_esm_build_templates_app-route_b2690e79.js.map