module.exports=[18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},28111,e=>{"use strict";var t=e.i(5246),a=e.i(9381),r=e.i(53516),n=e.i(88513),i=e.i(6151),s=e.i(50059),o=e.i(66602),l=e.i(52444),d=e.i(14694),p=e.i(49691),c=e.i(7726),u=e.i(34583),m=e.i(41813),h=e.i(36356),_=e.i(65931),f=e.i(93695);e.i(94173);var g=e.i(51092),w=e.i(44064);let v=(0,e.i(69343).createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY);async function x(e){try{let{chatbotId:t,sessionId:a,visitorInfo:r}=await e.json();if(!t||!r)return w.NextResponse.json({error:"Missing required fields"},{status:400});let{data:n,error:i}=await v.from("widget_chatbots").select("*").eq("id",t).eq("is_active",!0).single();if(i||!n)return w.NextResponse.json({error:"Chatbot not found"},{status:404});let s=r.firstName&&r.lastName?`${r.firstName} ${r.lastName}`.trim():r.name||"";if(a){let{error:e}=await v.from("widget_sessions").update({visitor_name:s,visitor_email:r.email,visitor_phone:r.phone,opt_in_email:r.optInEmail,opt_in_sms:r.optInSms,opt_in_phone:r.optInPhone}).eq("id",a);if(!e)return await R(n.user_id,r,a),w.NextResponse.json({sessionId:a,success:!0})}let o=`v_${Date.now()}_${Math.random().toString(36).substring(7)}`,{data:l,error:d}=await v.from("widget_sessions").insert({chatbot_id:t,user_id:n.user_id,visitor_id:o,visitor_name:s,visitor_email:r.email,visitor_phone:r.phone,opt_in_email:r.optInEmail,opt_in_sms:r.optInSms,opt_in_phone:r.optInPhone,status:"active"}).select().single();if(d)return console.error("Session creation error:",d),w.NextResponse.json({error:"Failed to create session"},{status:500});return await R(n.user_id,r,l.id),w.NextResponse.json({sessionId:l.id,success:!0})}catch(e){return console.error("Widget lead error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}async function R(e,t,a){try{let r=t.firstName||t.name?.split(" ")[0]||"",n=t.lastName||t.name?.split(" ").slice(1).join(" ")||"",{data:i}=await v.from("contacts").select("id, first_name, last_name, email, phone").eq("user_id",e).ilike("email",t.email),s=null;if(i&&i.length>0){s=i[0].id;let a=i[0],o={last_contact_date:new Date().toISOString()};t.optInEmail&&(o.opt_in_email=!0),t.optInSms&&(o.opt_in_sms=!0),t.optInPhone&&(o.opt_in_phone=!0),!a.phone&&t.phone&&(o.phone=t.phone),!a.first_name&&r&&(o.first_name=r),!a.last_name&&n&&(o.last_name=n),await v.from("contacts").update(o).eq("id",s),await v.from("activities").insert({user_id:e,contact_id:s,type:"System",title:"Chat Widget Interaction",detail:"Contact started a chat conversation"}),i.length>1&&console.log(`[Widget] Found ${i.length} contacts with email ${t.email} - consider merging`)}else{let{data:a}=await v.from("contacts").select("id, email").eq("user_id",e).ilike("first_name",r).ilike("last_name",n||r);if(a&&a.length>0&&!a[0].email)s=a[0].id,await v.from("contacts").update({email:t.email,phone:t.phone||a[0].phone,opt_in_email:t.optInEmail,opt_in_sms:t.optInSms,opt_in_phone:t.optInPhone,last_contact_date:new Date().toISOString()}).eq("id",s),await v.from("activities").insert({user_id:e,contact_id:s,type:"System",title:"Contact Updated via Chat",detail:"Email and details added from chat widget"});else{let{data:a}=await v.from("contacts").insert({user_id:e,first_name:r||"Unknown",last_name:n||"",email:t.email,phone:t.phone,company:"",source:"Chat Widget",status:"New",opt_in_email:t.optInEmail,opt_in_sms:t.optInSms,opt_in_phone:t.optInPhone,added_date:new Date().toISOString().split("T")[0],last_contact_date:new Date().toISOString()}).select("id").single();(s=a?.id||null)&&await v.from("activities").insert({user_id:e,contact_id:s,type:"System",title:"New Contact from Chat",detail:"Lead captured via chat widget"})}}s&&(await v.from("widget_sessions").update({contact_id:s}).eq("id",a),await v.from("widget_sessions").update({contact_id:s}).eq("user_id",e).eq("visitor_email",t.email).is("contact_id",null))}catch(e){console.error("Contact matching error:",e)}}e.s(["POST",()=>x],14563);var E=e.i(14563);let C=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/widget/lead/route",pathname:"/api/widget/lead",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/widget/lead/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:y,workUnitAsyncStorage:S,serverHooks:I}=C;function N(){return(0,r.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:S})}async function A(e,t,r){C.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/widget/lead/route";w=w.replace(/\/index$/,"")||"/";let v=await C.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:x,params:R,nextConfig:E,parsedUrl:y,isDraftMode:S,prerenderManifest:I,routerServerContext:N,isOnDemandRevalidate:A,revalidateOnlyGenerated:P,resolvedPathname:b,clientReferenceManifest:q,serverActionsManifest:O}=v,T=(0,o.normalizeAppPath)(w),j=!!(I.dynamicRoutes[T]||I.routes[b]),k=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,y,!1):t.end("This page could not be found"),null);if(j&&!S){let e=!!I.routes[b],t=I.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await k();throw new f.NoFallbackError}}let U=null;!j||C.isDev||S||(U="/index"===(U=b)?"/":U);let D=!0===C.isDev||!j,H=j&&!D;O&&q&&(0,s.setManifestsSingleton)({page:w,clientReferenceManifest:q,serverActionsManifest:O});let $=e.method||"GET",M=(0,i.getTracer)(),F=M.getActiveScopeSpan(),K={params:R,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,n)=>C.onRequestError(e,t,r,n,N)},sharedContext:{buildId:x}},L=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let s=async e=>C.handle(W,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=M.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${$} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${w}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&A&&P&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!j)return await (0,u.sendResponse)(L,B,i,K.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[_.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},!1,N),t}},p=await C.handleResponse({req:e,nextConfig:E,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:P,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:o});if(!j)return null;if((null==p||null==(i=p.value)?void 0:i.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,m.fromNodeOutgoingHttpHeaders)(p.value.headers);return o&&j||f.delete(_.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,h.getCacheControlHeader)(p.cacheControl)),await (0,u.sendResponse)(L,B,new Response(p.value.body,{headers:f,status:p.value.status||200})),null};F?await l(F):await M.withPropagatedContext(e.headers,()=>M.trace(p.BaseServerSpan.handleRequest,{spanName:`${$} ${w}`,kind:i.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},!1,N),j)throw t;return await (0,u.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>N,"routeModule",()=>C,"serverHooks",()=>I,"workAsyncStorage",()=>y,"workUnitAsyncStorage",()=>S],28111)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__0c9d8a8f._.js.map