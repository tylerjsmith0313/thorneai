module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},24491,e=>{"use strict";var t=e.i(5246),r=e.i(9381),s=e.i(53516),a=e.i(88513),n=e.i(6151),o=e.i(50059),i=e.i(66602),l=e.i(52444),d=e.i(14694),c=e.i(49691),u=e.i(7726),p=e.i(34583),g=e.i(41813),h=e.i(36356),w=e.i(65931),m=e.i(93695);e.i(94173);var f=e.i(51092),x=e.i(89660),v=e.i(44064);async function R(e){try{let{chatbotId:t,sessionId:r,message:s,visitorName:a,visitorEmail:n}=await e.json();if(!t||!s)return v.NextResponse.json({error:"Missing chatbotId or message"},{status:400});let o=await (0,x.createClient)(),{data:i,error:l}=await o.from("widget_chatbots").select("id, user_id, name, welcome_message, ai_instructions, theme_color, is_active").eq("id",t).eq("is_active",!0).single();if(l||!i)return v.NextResponse.json({error:"Chatbot not found or inactive"},{status:404});let d=r,c=null;if(r){let{data:e}=await o.from("widget_sessions").select("*").eq("id",r).single();c=e}if(!c){let{data:r,error:s}=await o.from("widget_sessions").insert({chatbot_id:t,user_id:i.user_id,visitor_name:a||null,visitor_email:n||null,source_url:e.headers.get("referer")||null,ip_address:e.headers.get("x-forwarded-for")?.split(",")[0]||null,user_agent:e.headers.get("user-agent")||null,status:"active"}).select().single();if(s)return console.error("[v0] Error creating session:",s),v.NextResponse.json({error:"Failed to create session"},{status:500});if(c=r,d=r.id,n){let{data:e}=await o.from("contacts").select("id").eq("email",n).eq("user_id",i.user_id).single();if(e)await o.from("widget_sessions").update({contact_id:e.id}).eq("id",d);else{let e=(a||"").split(" "),{data:t,error:r}=await o.from("contacts").insert({user_id:i.user_id,email:n,first_name:e[0]||"Widget",last_name:e.slice(1).join(" ")||"Visitor",source:"Widget Chat",tags:["widget-chat"],notes:`Lead captured via widget: ${i.name}`}).select("id").single();r&&console.error("[v0] Error creating contact from widget:",r),t&&await o.from("widget_sessions").update({contact_id:t.id}).eq("id",d)}}}let{data:u,error:p}=await o.from("widget_messages").insert({session_id:d,chatbot_id:t,user_id:i.user_id,sender_type:"visitor",content:s,is_read:!1}).select().single();if(p)return console.error("[v0] Error saving message:",p),v.NextResponse.json({error:"Failed to save message"},{status:500});return await o.from("widget_sessions").update({last_message_at:new Date().toISOString(),unread_count:c?(c.unread_count||0)+1:1}).eq("id",d),v.NextResponse.json({success:!0,sessionId:d,messageId:u.id,chatbot:{name:i.name,welcomeMessage:i.welcome_message,themeColor:i.theme_color}},{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}catch(e){return console.error("[v0] Widget message error:",e),v.NextResponse.json({error:"Internal server error"},{status:500})}}async function _(e){try{let{searchParams:t}=new URL(e.url),r=t.get("sessionId"),s=t.get("since");if(!r)return v.NextResponse.json({error:"Missing sessionId"},{status:400});let a=(await (0,x.createClient)()).from("widget_messages").select("*").eq("session_id",r).order("created_at",{ascending:!0});s&&(a=a.gt("created_at",s));let{data:n,error:o}=await a;if(o)return v.NextResponse.json({error:"Failed to fetch messages"},{status:500});return v.NextResponse.json({messages:n||[]},{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}catch(e){return console.error("[v0] Widget fetch error:",e),v.NextResponse.json({error:"Internal server error"},{status:500})}}async function C(){return new v.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}e.s(["GET",()=>_,"OPTIONS",()=>C,"POST",()=>R],50343);var A=e.i(50343);let E=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/widget/message/route",pathname:"/api/widget/message",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/widget/message/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:y,workUnitAsyncStorage:N,serverHooks:T}=E;function O(){return(0,s.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:N})}async function b(e,t,s){E.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/widget/message/route";x=x.replace(/\/index$/,"")||"/";let v=await E.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:R,params:_,nextConfig:C,parsedUrl:A,isDraftMode:y,prerenderManifest:N,routerServerContext:T,isOnDemandRevalidate:O,revalidateOnlyGenerated:b,resolvedPathname:P,clientReferenceManifest:j,serverActionsManifest:q}=v,S=(0,i.normalizeAppPath)(x),I=!!(N.dynamicRoutes[S]||N.routes[P]),k=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,A,!1):t.end("This page could not be found"),null);if(I&&!y){let e=!!N.routes[P],t=N.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await k();throw new m.NoFallbackError}}let H=null;!I||E.isDev||y||(H="/index"===(H=P)?"/":H);let M=!0===E.isDev||!I,U=I&&!M;q&&j&&(0,o.setManifestsSingleton)({page:x,clientReferenceManifest:j,serverActionsManifest:q});let D=e.method||"GET",F=(0,n.getTracer)(),$=F.getActiveScopeSpan(),K={params:_,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s,a)=>E.onRequestError(e,t,s,a,T)},sharedContext:{buildId:R}},L=new l.NodeNextRequest(e),G=new l.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let o=async e=>E.handle(W,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${D} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${x}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!i&&O&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(a);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&s.waitUntil&&(s.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!I)return await (0,p.sendResponse)(L,G,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[w.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,s=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:O})},!1,T),t}},c=await E.handleResponse({req:e,nextConfig:C,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:b,responseGenerator:d,waitUntil:s.waitUntil,isMinimalMode:i});if(!I)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",O?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&I||m.delete(w.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(L,G,new Response(c.value.body,{headers:m,status:c.value.status||200})),null};$?await l($):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${D} ${x}`,kind:n.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:O})},!1,T),I)throw t;return await (0,p.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>O,"routeModule",()=>E,"serverHooks",()=>T,"workAsyncStorage",()=>y,"workUnitAsyncStorage",()=>N],24491)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__c3a753c3._.js.map